
{% extends 'base.html' %}

{% csrf_token %}
{% block javascript %}
<script>
    var map;
    var markers = {};

    function favorite(element) {
        var csrftoken = getCookie('csrftoken');
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        $.ajax({
            type: 'POST',
            url: '/' + element.name + '/pet/',
            dataType: 'json',
            data: {
                id: element.id
            },
            success: function(response) {
                markers[element.id].setMap(null);
            }
        });
        $('#row-'+element.id).remove()
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 38.3079827, lng: -97.8934871},
            zoom: 4
        });

        var geocoder = new google.maps.Geocoder();
        {% for entry in favorites %}
            geocoder.geocode({
                    address: '{{ entry.zipcode }}',
                    region: 'US'
                },
                function(result, status) {
                    if (status == 'OK' && result.length > 0) {
                        var icon = {
                            url: '{{ entry.image }}',
                            scaledSize: new google.maps.Size(30,35),
                            origin: new google.maps.Point(0,0),
                            anchor: new google.maps.Point(0,0)
                        };
                        markers['{{ entry.animal_id }}'] = new google.maps.Marker({
                            position: result[0].geometry.location,
                            animation: google.maps.Animation.DROP,
                            map: map,
                            icon: icon,
                            title: '{{ entry.name }}',
                            url: '{{ entry.detail_link }}'
                        });
                        google.maps.event.addListener(markers['{{ entry.animal_id }}'], 'click', function() {
                            window.open(this.url, '_blank');
                        });
                    }
                }
            );
        {% endfor %}
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function csrfSafeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
</script>
{% endblock javascript %}

{% block content %}
{% include 'nav.html' %}
<div id="map" style="width: 100%; height: 450px; margin-bottom: 30px;"></div>
<div class="container container-fluid">
    <table class="table table-hover">
        <thead class="thead-dark">
            <tr>
                <th>Image</th>
                <th>Type</th>
                <th>Name</th>
                <th>Age</th>
                <th>Gender</th>
                <th>Size</th>
                <th>Description</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        {% for entry in favorites %}
            <tr id="row-{{ entry.animal_id }}">
                <td>
                    <a href="{{ entry.detail_link }}" target="_blank">
                        <img class="pet-image" src="{{ entry.image }}" onerror="this.src='http://placekitten.com/100/150'">
                    </a>
                </td>
                <td>{{ entry.animal_type }}</td>
                <td>{{ entry.name }}</td>
                <td>{{ entry.age }}</td>
                <td>{{ entry.gender }}</td>
                <td>{{ entry.size }}</td>
                <td class="break-word">{{ entry.description }}</td>
                <td>{{ entry.status }}</td>
                <td>
                    <button class="btn btn-danger" onclick="favorite(this)" name="delete" id="{{ entry.animal_id }}">Remove Favorite</button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock content %}